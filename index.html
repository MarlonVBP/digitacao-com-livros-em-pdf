<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Typer Reader Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Roboto+Mono:wght@400;500&display=swap");

      body {
        background-color: #0f172a;
        color: #e2e8f0;
        font-family: "Inter", sans-serif;
        overflow: hidden;
      }

      /* --- ESTILO DO PAPEL (Mais arredondado e espaçoso) --- */
      #page-card {
        background-color: #1e293b;
        /* Sombras suaves para profundidade */
        box-shadow:
          0 25px 50px -12px rgba(0, 0, 0, 0.6),
          0 0 0 1px rgba(255, 255, 255, 0.05); /* Borda sutil */
        transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); /* Efeito elástico */
        opacity: 0;
        transform: translateY(40px) scale(0.95);
      }

      #page-card.visible {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      #page-card.exiting {
        opacity: 0;
        transform: translateX(-100px) rotate(-5deg); /* Sai "voando" para esquerda */
      }

      /* Tipografia de Leitura */
      #typing-area {
        font-family: "Merriweather", serif;
        line-height: 2; /* Mais espaçamento entre linhas */
        font-size: 1.4rem;
        color: #64748b;
      }

      /* Blocos de Parágrafo */
      .line-block {
        display: block;
        margin-bottom: 0.75rem;
        min-height: 1.5rem;
      }

      /* Cursor e Cores */
      .cursor {
        background-color: #fbbf24;
        color: #000;
        border-radius: 4px;
        padding: 0 2px;
        box-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
      }
      .correct {
        color: #f1f5f9;
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.15);
        transition: color 0.1s;
      }
      .incorrect {
        color: #f87171;
        text-decoration: underline wavy #f87171;
        background-color: rgba(248, 113, 113, 0.1);
      }
      .pending {
        transition: color 0.3s;
      }

      /* Loader Elegante */
      .loader {
        width: 48px;
        height: 48px;
        border: 3px solid #334155;
        border-radius: 50%;
        display: inline-block;
        position: relative;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
      }
      .loader::after {
        content: "";
        box-sizing: border-box;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid;
        border-color: #3b82f6 transparent;
      }
      @keyframes rotation {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="h-screen w-screen flex flex-col items-center justify-center relative overflow-hidden"
  >
    <header
      class="absolute top-0 left-0 w-full p-8 flex justify-between items-center z-20 pointer-events-none"
    >
      <h1
        class="text-2xl font-bold tracking-widest text-slate-500 pointer-events-auto"
      >
        PDF<span class="text-blue-500">READER</span>
      </h1>

      <div
        class="flex gap-4 text-sm font-mono opacity-0 transition-opacity duration-500 pointer-events-auto"
        id="stats-container"
      >
        <div
          class="bg-slate-800/80 backdrop-blur border border-slate-700 px-4 py-2 rounded-xl flex items-center gap-2 shadow-lg"
        >
          <i class="fas fa-book text-blue-400"></i>
          <span
            >Pág
            <span id="page-display" class="text-white font-bold">1</span></span
          >
        </div>
        <div
          class="bg-slate-800/80 backdrop-blur border border-slate-700 px-4 py-2 rounded-xl flex items-center gap-2 shadow-lg"
        >
          <i class="fas fa-tachometer-alt text-yellow-400"></i>
          <span id="wpm-display" class="text-white font-bold">0</span> WPM
        </div>
      </div>
    </header>

    <div
      id="upload-screen"
      class="flex flex-col items-center gap-8 transition-all duration-500 z-10"
    >
      <div
        class="w-[500px] h-64 bg-slate-800/50 border-2 border-dashed border-slate-600 rounded-3xl flex flex-col items-center justify-center hover:border-blue-500 hover:bg-slate-800 hover:scale-105 cursor-pointer transition-all group shadow-2xl"
        onclick="document.getElementById('file-input').click()"
      >
        <div
          class="bg-slate-700 p-4 rounded-full mb-4 group-hover:bg-blue-600 transition-colors"
        >
          <i class="fas fa-file-pdf text-3xl text-white"></i>
        </div>
        <p class="text-xl font-medium text-slate-200">Carregar Livro PDF</p>
        <p class="text-sm text-slate-500 mt-2">
          Tecnologia OCR (Lê qualquer PDF)
        </p>
      </div>

      <div
        class="bg-slate-800 p-1 rounded-2xl border border-slate-700 flex items-center shadow-lg"
      >
        <span class="px-4 text-slate-400 font-medium text-sm"
          >Começar na página:</span
        >
        <input
          type="number"
          id="start-page-input"
          value="1"
          min="1"
          class="bg-slate-900 text-white w-20 p-2 rounded-xl text-center outline-none focus:ring-2 focus:ring-blue-500 font-bold border border-slate-700"
        />
      </div>

      <input type="file" id="file-input" accept=".pdf" class="hidden" />
    </div>

    <div
      id="loader-screen"
      class="hidden absolute inset-0 bg-[#0f172a] z-30 flex flex-col items-center justify-center"
    >
      <span class="loader mb-6"></span>
      <h2 class="text-2xl font-light text-white">
        Decifrando Página
        <span id="loading-page-num" class="text-blue-400 font-bold">1</span>
      </h2>
      <p class="text-slate-500 mt-2 text-sm">
        Aplicando Inteligência Artificial...
      </p>
    </div>

    <div
      id="page-container"
      class="hidden w-full max-w-5xl h-[85vh] flex flex-col relative z-10"
    >
      <div
        id="page-card"
        class="flex-1 bg-slate-800/80 backdrop-blur-sm rounded-[2.5rem] border border-slate-700 overflow-hidden relative flex flex-col"
      >
        <div class="w-full h-1 bg-slate-700 absolute top-0 left-0">
          <div
            id="reading-progress"
            class="h-full bg-gradient-to-r from-blue-500 to-green-400 transition-all duration-300"
            style="width: 0%"
          ></div>
        </div>

        <div id="scroll-wrapper" class="flex-1 overflow-hidden p-12 md:p-20">
          <div id="typing-area" class="select-none outline-none"></div>
        </div>

        <div
          id="next-page-overlay"
          class="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center opacity-0 pointer-events-none transition-all duration-500 z-20"
        >
          <div
            class="bg-slate-800 p-8 rounded-3xl border border-slate-700 text-center shadow-2xl transform scale-90 transition-transform duration-500"
            id="stats-card"
          >
            <i
              class="fas fa-trophy text-5xl text-yellow-400 mb-4 animate-bounce"
            ></i>
            <h3 class="text-3xl font-bold text-white mb-1">
              Página Concluída!
            </h3>
            <div class="flex justify-center gap-8 my-6">
              <div class="text-center">
                <p class="text-slate-500 text-xs uppercase tracking-wider">
                  Velocidade
                </p>
                <p class="text-2xl font-mono text-white">
                  <span id="final-wpm">0</span>
                  <span class="text-sm text-slate-500">WPM</span>
                </p>
              </div>
              <div class="text-center">
                <p class="text-slate-500 text-xs uppercase tracking-wider">
                  Precisão
                </p>
                <p class="text-2xl font-mono text-white">
                  <span id="final-acc">100</span
                  ><span class="text-sm text-slate-500">%</span>
                </p>
              </div>
            </div>
            <button
              id="btn-next-page"
              class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold shadow-lg transition transform hover:scale-105 flex items-center justify-center gap-2 group"
            >
              Próxima Página
              <i
                class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"
              ></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

      let pdfDoc = null;
      let currentPage = 1;
      let totalPages = 0;
      let originalText = "";
      let currentIndex = 0;
      let startTime = null;
      let errors = 0;
      let isTypingEnabled = false;

      const uploadScreen = document.getElementById("upload-screen");
      const loaderScreen = document.getElementById("loader-screen");
      const pageContainer = document.getElementById("page-container");
      const pageCard = document.getElementById("page-card");
      const typingArea = document.getElementById("typing-area");
      const nextPageOverlay = document.getElementById("next-page-overlay");
      const statsCard = document.getElementById("stats-card");
      const progressBar = document.getElementById("reading-progress");

      // --- 1. UPLOAD E SELEÇÃO DE PÁGINA ---
      document
        .getElementById("file-input")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // 1. Pega o valor do input de página
          const userStartPage =
            parseInt(document.getElementById("start-page-input").value) || 1;

          uploadScreen.classList.add("opacity-0");
          setTimeout(() => uploadScreen.classList.add("hidden"), 500);

          const arrayBuffer = await file.arrayBuffer();
          pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
          totalPages = pdfDoc.numPages;

          // 2. Valida a página escolhida
          currentPage = userStartPage;
          if (currentPage < 1) currentPage = 1;
          if (currentPage > totalPages) {
            alert(
              `O documento só tem ${totalPages} páginas. Começando na última.`,
            );
            currentPage = totalPages;
          }

          loadPage(currentPage);
        });

      // --- 2. CARREGAMENTO (OCR) ---
      async function loadPage(pageNum) {
        isTypingEnabled = false;
        loaderScreen.classList.remove("hidden");
        pageContainer.classList.add("hidden");
        pageCard.className =
          "flex-1 bg-slate-800/80 backdrop-blur-sm rounded-[2.5rem] border border-slate-700 overflow-hidden relative flex flex-col"; // Reset classes
        nextPageOverlay.classList.remove("opacity-100", "pointer-events-auto");
        nextPageOverlay.classList.add("opacity-0", "pointer-events-none");
        statsCard.classList.remove("scale-100");
        statsCard.classList.add("scale-90");

        document.getElementById("loading-page-num").innerText = pageNum;
        document.getElementById("page-display").innerText =
          `${pageNum} / ${totalPages}`;
        progressBar.style.width = "0%";

        try {
          const page = await pdfDoc.getPage(pageNum);
          const viewport = page.getViewport({ scale: 1.5 });
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          await page.render({ canvasContext: ctx, viewport: viewport }).promise;

          const worker = await Tesseract.createWorker("por");
          const { data } = await worker.recognize(canvas);
          await worker.terminate();

          if (data.text.trim().length < 5) {
            alert("Página vazia ou ilegível. Tentando próxima...");
            if (currentPage < totalPages) {
              currentPage++;
              loadPage(currentPage);
              return;
            }
          }

          prepareGame(data.text);
        } catch (err) {
          alert("Erro: " + err.message);
          location.reload();
        }
      }

      // --- 3. RENDERIZAÇÃO VISUAL ---
      function prepareGame(rawText) {
        originalText = cleanText(rawText);
        currentIndex = 0;
        errors = 0;
        startTime = null;

        typingArea.innerHTML = "";
        const lines = originalText.split("\n");

        lines.forEach((line) => {
          if (line.trim() === "") return;
          const div = document.createElement("div");
          div.className = "line-block";

          line.split("").forEach((char) => {
            const span = document.createElement("span");
            span.innerText = char;
            span.className = "pending transition-colors duration-200";
            div.appendChild(span);
          });

          const spaceSpan = document.createElement("span");
          spaceSpan.innerText = " ";
          spaceSpan.className = "pending";
          div.appendChild(spaceSpan);
          typingArea.appendChild(div);
        });

        loaderScreen.classList.add("hidden");
        pageContainer.classList.remove("hidden");
        document
          .getElementById("stats-container")
          .classList.remove("opacity-0");

        setTimeout(() => pageCard.classList.add("visible"), 50);
        updateCursor();
        isTypingEnabled = true;
      }

      function cleanText(text) {
        return text
          .replace(/\|/g, "I")
          .replace(/([a-z])-\n([a-z])/g, "$1$2")
          .trim();
      }

      // --- 4. GAME ENGINE ---
      window.addEventListener("keydown", (e) => {
        if (!isTypingEnabled) return;
        if (e.key.length > 1 && e.key !== "Backspace") return;
        if (e.key === "Enter") return;

        if (!startTime) startTime = new Date();

        const spans = document.querySelectorAll("#typing-area span");
        if (currentIndex >= spans.length - 1) return;

        if (e.key === "Backspace") {
          if (currentIndex > 0) {
            spans[currentIndex].className =
              "pending transition-colors duration-200";
            currentIndex--;
            spans[currentIndex].className =
              "pending transition-colors duration-200";
            updateCursor();
          }
          return;
        }

        if (e.key === " ") e.preventDefault();

        const targetChar = spans[currentIndex].innerText;
        if (e.key.toLowerCase() === targetChar.toLowerCase()) {
          // Case insensitive opcional para conforto
          spans[currentIndex].className = "correct";
        } else {
          spans[currentIndex].className = "incorrect";
          errors++;
        }

        currentIndex++;
        updateCursor();
        updateStats();

        // Progress Bar
        const progress = (currentIndex / (spans.length - 1)) * 100;
        progressBar.style.width = `${progress}%`;

        if (currentIndex >= spans.length - 1) finishPage();
      });

      function updateCursor() {
        const spans = document.querySelectorAll("#typing-area span");
        document
          .querySelectorAll(".cursor")
          .forEach((c) => c.classList.remove("cursor"));
        if (spans[currentIndex]) {
          spans[currentIndex].classList.add("cursor");
          // Scroll behavior: block center mantém o cursor no meio verticalmente
          spans[currentIndex].scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
        }
      }

      function updateStats() {
        const time = (new Date() - startTime) / 1000 / 60;
        if (time > 0) {
          const wpm = Math.round(currentIndex / 5 / time);
          const acc = Math.max(
            0,
            Math.round(((currentIndex - errors) / currentIndex) * 100),
          );
          document.getElementById("wpm-display").innerText = wpm;
          document.getElementById("final-wpm").innerText = wpm;
          document.getElementById("final-acc").innerText = acc;
        }
      }

      // --- 5. PAGINAÇÃO ---
      function finishPage() {
        isTypingEnabled = false;
        nextPageOverlay.classList.remove("opacity-0", "pointer-events-none");
        nextPageOverlay.classList.add("opacity-100", "pointer-events-auto");
        setTimeout(() => statsCard.classList.remove("scale-90"), 100);
        setTimeout(() => statsCard.classList.add("scale-100"), 100);
      }

      document.getElementById("btn-next-page").addEventListener("click", () => {
        if (currentPage < totalPages) {
          pageCard.classList.remove("visible");
          pageCard.classList.add("exiting");
          setTimeout(() => {
            currentPage++;
            loadPage(currentPage);
          }, 500);
        } else {
          alert("Fim do livro!");
          location.reload();
        }
      });
    </script>
  </body>
</html>
